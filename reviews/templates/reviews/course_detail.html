{% extends "base.html" %}

{% block content %}



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* Additional custom styles */
    /* General Layout and Container Styles */
    body, html {
        background-color: #000000 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow-x: hidden !important;
    }
    
    /* Reset the container styles for the main content only */
    .container-main .container,
    .container-main .container-fluid,
    main .container,
    main .container-fluid {
        background-color: #000000 !important;
        max-width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    /* Preserve navbar styling */
    header .navbar .container {
        background-color: #000000 !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
        margin-left: auto !important;
        margin-right: auto !important;
        max-width: 1320px !important; /* Bootstrap default for large screens */
    }
    
    /* Navbar brand and logo styling */
    .navbar-brand {
        margin-left: 15px !important;
        padding-left: 15px !important;
    }
    
    /* Logo specific styling */
    .logo {
        width: 110px;
        height: 110px;
        margin-right: 15px !important;
    }
    
    /* Ensure all rows have no margins in the main content */
    .container-main .row,
    main .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
    }
    
    /* Ensure all columns have black backgrounds */
    [class*="col-"] {
        background-color: #000000 !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
    }
    
    .review-container {
        background-color: #1a1a1a !important;
        border-radius: 8px;
        padding: 20px;
        color: #f1f1f1;
    }

    .review-item {
        display: flex;
        /* Use flexbox to lay out children */
        flex-wrap: wrap;
        /* Allow wrapping for reply section */
        align-items: flex-start;
        /* Align children at the top */
        background-color: #1a1a1a !important;
        border-radius: 4px;
        margin-bottom: 20px;
        padding: 15px;
        padding-left: 50px;  /* Reduced space for the voting buttons */
        box-shadow: 0 2px 4px rgba(0, 0, 0, .2);
        position: relative;
        /* Establish a positioning context */
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        width: 100%;
    }

    .review-actions-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .report-btn {
        font-size: 0.8rem;
        padding: 2px 5px;
        color: #dc3545;
        border-color: #dc3545;
    }

    .report-btn:hover {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .report-icon {
        color: #dc3545;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        transition: color 0.2s;
    }

    .report-icon:hover {
        color: #b02a37;
    }

    .reviews-container {
        background-color: #000000 !important;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        width: 100%;
    }

    .container-main {
        background-color: #000000 !important;
        color: #ffffff;
        font-weight: 100;
        padding: 0;
        max-width: 100%;
        margin: 0;
    }
    
    .row {
        margin: 0;
        width: 100%;
    }
    
    .col-md-8.offset-md-2 {
        background-color: #000000 !important;
    }

    /* Typography and Text Styles */
    .review-major,
    .topicx {
        font-family: PF Fuel Grime;
        font-size: 1.3em;
        font-weight: 10;
        color: #ffffff;
    }

    .review-date {
        font-size: 0.8em;
        color: #cccccc;
    }

    .review-body {
        border-top: 1px solid #444;
        padding-top: 10px;
        width: 100%;
    }

    .review-text {
        font-size: 0.9em;
        color: #f1f1f1 !important;
        font-weight: 100;
    }

    .mt-6,
    .list-unstyled .text-primary {
        color: #dba309;
        font-size: 1.2em;
    }

    label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
    }

    /* Buttons and Form Elements */
    .btn-delete,
    .btn-primary,
    .btn-third {
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        margin-top: 10px;
        font-size: 0.8em;
    }

    .btn-primary {
        background-color: #dba309;
        color: #000000;
        margin-bottom: 5%;
    }

    .btn-primary:hover {
        background-color: #000000;
        color: #dba309;
    }

    .form-control {
        border-radius: 0.25rem;
    }


    .form-group {
        margin-bottom: 15px;
    }

    .review-container textarea {
        width: 100%;
        height: 150px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        resize: vertical;
    }

    textarea[name="teacher_name"] {
        height: 20px;
    }

    /* Star Rating and Other Specific Elements */
    .star-rating {
        font-size: 1.2em;
        color: #dba309;
        font-weight: 100;
        display: flex;
        justify-content: right;
    }

    .rating-holder {
        display: flex;
        justify-content: right;
    }

    .helptext-container {
        text-align: center;
    }

    .helptext-container p {
        display: inline-block;
        margin: 0;
    }

    /* Responsive Adjustments and Miscellaneous */
    .topicx {
        font-size: 1.5em;
        margin-left: 2.25%;
        margin-top: 40px;
    }

    .review-item:last-child {
        border-bottom: none;
    }

    .review-content {
        flex: 1;
        /* Make the content take up all available space */
        min-width: 0;
        /* Prevent flex items from overflowing */
        width: 100%;
        /* Ensure full width */
        margin-bottom: 10px;
        padding-right: 15px; /* Add some space on the right */
    }

    .review-voting {
        position: absolute;
        left: 5px; /* Reduced left margin */
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .review-actions {
        position: static; /* Change from absolute to static */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    /* Upvote and Downvote Button Styles */
    .btn-upvote,
    .btn-downvote {
        background-color: transparent; /* Transparent background */
        color: white;
        border: none;
        padding: 0; /* Remove padding */
        margin-bottom: 5px; /* Space between buttons */
        cursor: pointer;
        text-align: center;
        display: flex; /* Use flexbox for alignment */
        align-items: center; /* Center items vertically */
    }

    /* Arrow styles */
    .vote-arrow {
        display: block;
        width: 0; 
        height: 0; 
        border-style: solid;
    }

    .up-arrow {
        border-width: 0 5px 8px 5px;
        border-color: transparent transparent #4CAF50 transparent; /* Green arrow pointing up */
        margin-left: 5px;
    }

    .down-arrow {
        border-width: 8px 5px 0 5px;
        border-color: #f44336 transparent transparent transparent; /* Red arrow pointing down */
        margin-left: 5px;
    }

    .vote-count {
        font-size: 1em;
        margin: 7px; /* Space between number and arrow */
    }

    /* Hover effect for the buttons */
    .btn-upvote:hover .up-arrow,
    .btn-downvote:hover .down-arrow {
        opacity: 0.8;
    }

    /* Review replies container should take full width */
    .review-replies {
        width: 100%;
        margin-top: 15px;
        margin-left: 0;
        padding-left: 20px;
        box-sizing: border-box;
    }

    .reply-item {
        background-color: #222222 !important;
        border-left: 3px solid #dba309 !important;
        padding: 10px !important;
        margin-bottom: 10px !important;
        width: 100%;
        box-sizing: border-box;
    }

    .reply-header {
        margin-bottom: 5px;
    }

    .reply-content {
        color: #f1f1f1 !important;
        width: 100%;
    }

    .reply-form-container {
        margin-top: 15px;
        padding: 10px;
        background-color: #222222 !important;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
    }

    .reply-toggle {
        background-color: transparent;
        color: #dba309;
        border: 1px solid #dba309;
        margin-top: 10px;
    }

    .reply-toggle:hover {
        background-color: #dba309;
        color: #000000;
    }

    /* Reply button container */
    .text-left {
        width: 100%;
        margin-top: 10px;
        padding-left: 0;
        text-align: left;
    }

    /* Delete reply link */
    .delete-reply-link {
        color: #e74c3c;
        text-decoration: none;
        font-size: 0.8em;
    }

    .delete-reply-link:hover {
        color: #c0392b;
        text-decoration: underline;
    }

    /* Form check styling */
    .form-check {
        display: flex;
        align-items: center;
    }

    .form-check-input {
        margin-right: 8px;
    }

    .form-check-label {
        margin-bottom: 0;
        color: #f1f1f1;
        font-size: 0.9em;
    }

    /* Text colors for better contrast */
    .text-muted {
        color: #a0a0a0 !important;
    }

    .anonymous-reply {
        color: #dba309 !important;
        font-weight: bold;
    }

    /* Year filter styling */
    .year-filter {
        margin-bottom: 20px;
    }

    .year-filter form {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .year-filter label {
        margin-bottom: 0;
        margin-right: 10px;
        font-weight: normal;
    }

    .year-filter select {
        padding: 8px 12px;
        border-radius: 4px;
        background-color: #1a1a1a;
        color: #f1f1f1;
        border: 1px solid #444;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .review-item {
            padding-left: 40px;
        }
        
        .review-voting {
            left: 5px;
        }
        
        .year-filter form {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .year-filter label {
            margin-bottom: 5px;
        }
        
        .year-filter select {
            width: 100%;
        }
    }

    @media (max-width: 576px) {
        .review-item {
            padding-left: 10px;
        }
        
        .review-voting {
            position: relative;
            left: 0;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            width: 100%;
            margin-bottom: 10px;
            transform: none;
        }
        
        .review-actions {
            flex-direction: row;
        }
        
        .btn-upvote, .btn-downvote {
            margin-bottom: 0;
            margin-right: 5px;
        }
        
        .vote-count {
            margin: 0 10px;
        }
    }

    /* Flag button styles */
    .btn-outline-secondary.report-btn {
        color: #6c757d;
        border-color: #6c757d;
    }
    
    .btn-outline-secondary.report-btn:hover {
        color: #dc3545;
        border-color: #dc3545;
    }

    /* Flag icon styles for reviews (no stroke) */
    .btn-outline-none.report-btn {
        color: #6c757d;
        background: transparent;
    }
    
    .btn-outline-none.report-btn:hover {
        color: #dc3545;
        background: transparent;
    }

    /* Modal and Toast styling */
    .modal-content {
        background-color: #1a1a1a !important;
        color: #f1f1f1 !important;
    }
    
    .modal-header, .modal-footer {
        border-color: #333 !important;
    }
    
    .toast {
        background-color: #1a1a1a !important;
        color: #f1f1f1 !important;
    }
    
    .toast-header {
        background-color: #000000 !important;
        color: #f1f1f1 !important;
        border-color: #333 !important;
    }
    
    /* Fix for any potential Bootstrap container margins */
    .container, .container-fluid {
        background-color: #000000 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    /* Archived badge styling */
    .archived-badge {
        display: inline-block;
        background-color: #dc3545;
        color: white;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
        vertical-align: middle;
    }

</style>



<div class="container-main">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2 class="display-4">
                {{ course.name }} <span class="text-muted">({{ course.code }})</span>
                {% if is_staff_or_superuser and course.archived %}
                <span class="archived-badge">Archived</span>
                {% endif %}
            </h2>
            <p><strong>Average Rating:</strong> {{ course.average_rating }} / 5.0</p>
            <!-- ... truncated course description and button ... -->
            <div id="courseSummaryShort">
                <p>{{ course.description|truncatechars:800 }}.</p>
                <div class="d-flex align-items-center">
                    <button id="toggleSummary" class="btn btn-primary" onclick="toggleDescription()">Read More</button>
                </div>
            </div>

            <div id="courseSummaryFull" style="display: none;">
                <p>{{ course.description }}</p>
                <div class="d-flex align-items-center">
                    <button id="toggleSummary" class="btn btn-primary" onclick="toggleDescription()">Read Less</button>
                </div>
            </div>

            <!-- Add the report button after both summary sections -->
            {% if not user_reported and not course.is_verified %}
            <div class="mt-2">
                <button type="button" class="btn btn-link text-danger p-0" id="reportCourseBtn" style="text-decoration: none;">
                    Not a real course?
                </button>
            </div>
            {% endif %}

            <h3 class="topicx">Reviews:</h3>
            <div class="year-filter">
                <form method="get" action=".">
                    <label for="year">Filter by Year:</label>
                    <select name="year" onchange="this.form.submit()">
                        <option value="">All Years</option>
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year|stringformat:"s" == current_year %}selected{% endif %}>
                            {{ year }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            <div class="reviews-container">
                <ul class="list-unstyled">
                    <!-- Assuming each review is within a div with class 'review-item' inside the 'review-container' -->
                    <div class="review-container">
                        {% for review in reviews %}
                        <div class="review-item">
                            <div class="review-voting">
                                <form method="post" class="review-actions">
                                    {% csrf_token %}
                                    <input type="hidden" name="review_id" value="{{ review.id }}">
                                    <button type="submit" name="vote" value="upvote" class="btn btn-upvote" title="Was this review constructive?">
                                        <span class="vote-arrow up-arrow"></span>
                                    </button>
                                    <span class="vote-count">{{ review.net_votes }}</span>
                                    <button type="submit" name="vote" value="downvote" class="btn btn-downvote" title="Was this review unhelpful?">
                                        <span class="vote-arrow down-arrow"></span>
                                    </button>
                                </form>
                            </div>
                            
                            <div class="review-content">
                                <div class="review-header">
                                    <span class="review-major">
                                        {{ review.user.major }} - {{ review.user.track }}
                                        {% if is_staff_or_superuser and review.archived %}
                                        <span class="archived-badge">Archived</span>
                                        {% endif %}
                                    </span>
                                    <div class="review-actions-container">
                                        <span class="review-date">Posted on: {{ review.created_date }}</span>
                                    </div>
                                </div>
                                <div class="review-body">
                                    <p class="review-text">{{ review.text }}</p>
                                    <p>
                                        {% if user.is_authenticated and review.user == user %}
                                        <span>
                                            <form method="post" class="review-actions-delete">
                                                {% csrf_token %}
                                                <input type="hidden" name="review_id" value="{{ review.id }}">
                                                <button type="submit" name="delete_review"
                                                    class="btn-delete">Delete</button>
                                            </form>
                                        </span>
                                        {% endif %}
                                        <span class="star-rating"
                                            data-rating="{{ review.rating|floatformat:1 }}"></span>
                                        <span class="rating-holder"> {{ review.rating|floatformat:1 }}/5.0 </span>
                                    </p>
                                </div>
                            </div>

                            <!-- Review Replies -->
                            <div class="review-replies mt-3">
                                {% for reply in review.replies.all %}
                                <div class="reply-item p-2 mb-2 border-left border-light">
                                    <div class="reply-header d-flex justify-content-between">
                                        <small class="text-muted">
                                            {% if reply.is_anonymous %}
                                                <span class="anonymous-reply">Anonymous</span> replied {{ reply.created_date|timesince }} ago
                                            {% else %}
                                                {{ reply.user.username }} replied {{ reply.created_date|timesince }} ago
                                            {% endif %}
                                        </small>
                                        {% if user.is_authenticated and reply.user == user %}
                                        <small>
                                            <a href="{% url 'reviews:delete_reply' course.id reply.id %}" 
                                               class="text-danger delete-reply-link"
                                               onclick="return confirm('Are you sure you want to delete this reply?');">
                                                Delete
                                            </a>
                                        </small>
                                        {% endif %}
                                    </div>
                                    <div class="reply-content">
                                        {{ reply.text|linebreaks }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Bottom Actions -->
                            <div class="mt-2">
                                {% if user.is_authenticated %}
                                <!-- Reply Button -->
                                <div class="text-left">
                                    <button class="btn btn-sm btn-outline-primary reply-toggle" 
                                            data-review-id="{{ review.id }}">
                                        Reply
                                    </button>
                                </div>
                                
                                <!-- Flag Icon (positioned at bottom right) -->
                                <div class="text-right" style="position: absolute; bottom: 15px; right: 15px;">
                                    {% if review.id not in reported_reviews %}
                                    <a href="{% url 'reviews:report_review' course.id review.id %}" class="btn btn-sm btn-outline-none report-btn" style="padding: 0.25rem 0.5rem; display: flex; align-items: center; border: none;" title="Report this review">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L14.5 8l.186.464-.003.001-.006.003-.023.009a12.435 12.435 0 0 1-.397.15c-.264.095-.631.223-1.047.35-.816.252-1.879.523-2.71.523-.847 0-1.548-.28-2.158-.525l-.028-.01C7.68 8.71 7.14 8.5 6.5 8.5c-.7 0-1.638.23-2.437.477A19.626 19.626 0 0 0 3 9.342V15.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 1 0v.282c.226-.079.496-.17.79-.26C4.606.272 5.67 0 6.5 0c.84 0 1.524.277 2.121.519l.043.018C9.286.788 9.828 1 10.5 1c.7 0 1.638-.23 2.437-.477a19.587 19.587 0 0 0 1.349-.476l.019-.007.004-.002h.001"/>
                                        </svg>
                                    </a>
                                    {% else %}
                                    <span class="btn btn-sm btn-outline-none disabled" style="padding: 0.25rem 0.5rem; display: flex; align-items: center; border: none;" title="You've already reported this review">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L14.5 8l.186.464-.003.001-.006.003-.023.009a12.435 12.435 0 0 1-.397.15c-.264.095-.631.223-1.047.35-.816.252-1.879.523-2.71.523-.847 0-1.548-.28-2.158-.525l-.028-.01C7.68 8.71 7.14 8.5 6.5 8.5c-.7 0-1.638.23-2.437.477A19.626 19.626 0 0 0 3 9.342V15.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 1 0v.282c.226-.079.496-.17.79-.26C4.606.272 5.67 0 6.5 0c.84 0 1.524.277 2.121.519l.043.018C9.286.788 9.828 1 10.5 1c.7 0 1.638-.23 2.437-.477a19.587 19.587 0 0 0 1.349-.476l.019-.007.004-.002h.001"/>
                                        </svg>
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Reply Form (hidden by default) -->
                            <div class="reply-form-container mt-2" id="reply-form-{{ review.id }}" style="display: none;">
                                <form method="post" action="{% url 'reviews:add_reply' course.id review.id %}">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        {{ reply_form.text }}
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" name="is_anonymous" id="is_anonymous_{{ review.id }}" class="form-check-input">
                                        <label class="form-check-label" for="is_anonymous_{{ review.id }}">
                                            Post anonymously
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">Submit Reply</button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-reply" 
                                            data-review-id="{{ review.id }}">Cancel</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                </ul>
            </div>
            <!-- ... add review form and related scripts ... -->

            {% if user.is_authenticated %}
            <div class="container mt-5">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div class="text-center mb-4">
                            <button id="addReviewButton" class="btn btn-third" onclick="toggleReviewForm()">Add a
                                Review</button>
                        </div>
                        <div id="reviewForm" class="review-container" style="display: none;">
                            <h2 class="text-center mb-4">Add a Review</h2>
                            <form method="post">
                                {% csrf_token %}
                                {{ form.as_p }}
                                <button type="submit" class="btn btn-success">Submit Review</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="helptext-container">
                <p>
                    <a href="{% url 'users:login' %}?next={{ request.path }}">Login</a> or
                    <a href="{% url 'users:register' %}?next={{ request.path }}">Register</a> to add a review.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function toggleReviewForm() {
        var form = document.getElementById("reviewForm");
        if (form.style.display === "none") {
            form.style.display = "block";
        } else {
            form.style.display = "none";
        }
    }

    function toggleDescription() {
        let shortSummary = document.getElementById("courseSummaryShort");
        let fullSummary = document.getElementById("courseSummaryFull");
        let toggleButton = document.getElementById("toggleSummary");

        if (shortSummary.style.display === "none") {
            shortSummary.style.display = "block";
            fullSummary.style.display = "none";
            toggleButton.innerText = "Read More";
        } else {
            shortSummary.style.display = "none";
            fullSummary.style.display = "block";
            toggleButton.innerText = "Read Less";
        }
    }


    function updateStarRatings() {
        // Select all elements with the class 'starRating'
        const ratingElements = document.querySelectorAll('.star-rating');
        ratingElements.forEach(el => {
            let rating = parseFloat(el.getAttribute('data-rating'));
            rating = Math.round(rating); // Round to the nearest whole number
            el.innerHTML = ''; // Clear any existing stars
            for (let i = 1; i <= rating; i++) {
                if (i <= rating) {
                    el.innerHTML += '<span class="star">&#9733;</span>'; // Full star
                } else {
                    el.innerHTML += '<span class="star gray">&#9733;</span>'; // Empty star
                }
            }
            // If there is no rating (e.g., rating is NaN), clear the stars
            if (isNaN(rating)) {
                el.innerHTML = 'No ratings yet';
                el.nextElementSibling.innerHTML = ''; // Clear the '/5.0'
            }
        });
    }


    document.addEventListener('DOMContentLoaded', updateStarRatings);

    // Reply form toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up reply functionality');
        
        // Show reply form when Reply button is clicked
        const replyButtons = document.querySelectorAll('.reply-toggle');
        console.log('Found ' + replyButtons.length + ' reply buttons');
        
        replyButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const reviewId = this.getAttribute('data-review-id');
                console.log('Reply button clicked for review ID: ' + reviewId);
                
                const replyForm = document.getElementById(`reply-form-${reviewId}`);
                if (replyForm) {
                    replyForm.style.display = 'block';
                    this.style.display = 'none';
                    console.log('Reply form displayed');
                } else {
                    console.error('Reply form not found for review ID: ' + reviewId);
                }
            });
        });
        
        // Hide reply form when Cancel button is clicked
        const cancelButtons = document.querySelectorAll('.cancel-reply');
        console.log('Found ' + cancelButtons.length + ' cancel buttons');
        
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const reviewId = this.getAttribute('data-review-id');
                console.log('Cancel button clicked for review ID: ' + reviewId);
                
                const replyForm = document.getElementById(`reply-form-${reviewId}`);
                const replyButton = document.querySelector(`.reply-toggle[data-review-id="${reviewId}"]`);
                
                if (replyForm) {
                    replyForm.style.display = 'none';
                    console.log('Reply form hidden');
                }
                
                if (replyButton) {
                    replyButton.style.display = 'inline-block';
                    console.log('Reply button shown');
                }
            });
        });
        
        // Add hover effect for flag icons
        const flagIcons = document.querySelectorAll('a[href*="report_review"]');
        flagIcons.forEach(icon => {
            icon.addEventListener('mouseover', function() {
                this.style.color = '#dc3545';
            });
            icon.addEventListener('mouseout', function() {
                this.style.color = '#6c757d';
            });
        });
    });
</script>

<!-- Toast for confirmation -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="reportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header">
            <strong class="me-auto">Course Report</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Thank you for your report. We'll review this course.
        </div>
    </div>
</div>

<!-- Add this JavaScript to handle the button clicks -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const voteRealBtn = document.getElementById('voteRealBtn');
  const voteNotRealBtn = document.getElementById('voteNotRealBtn');
  const reportToast = new bootstrap.Toast(document.getElementById('reportToast'));
  const toastMessage = document.getElementById('toastMessage');
  const modalElement = document.getElementById('courseRealityModal');
  
  // Make sure the modal is properly initialized
  const courseRealityModal = new bootstrap.Modal(modalElement);
  
  function submitVote(voteType) {
    // Send the vote via AJAX
    fetch("{% url 'reviews:report_course' course.id %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ vote: voteType })
    })
    .then(response => response.json())
    .then(data => {
      // Close the modal immediately
      courseRealityModal.hide();
      
      // Show the toast with the response message
      toastMessage.textContent = data.message;
      reportToast.show();
      
      // If the vote was successful, remove the button
      if (data.success) {
        const reportBtn = document.getElementById('reportCourseBtn');
        if (reportBtn) {
          reportBtn.remove();
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      
      // Close the modal
      courseRealityModal.hide();
      
      // Show error toast
      toastMessage.textContent = 'An error occurred. Please try again.';
      reportToast.show();
    });
  }
  
  voteRealBtn.addEventListener('click', function() {
    submitVote('real');
  });
  
  voteNotRealBtn.addEventListener('click', function() {
    submitVote('not_real');
  });
  
  // Make sure the button correctly opens the modal
  const reportBtn = document.getElementById('reportCourseBtn');
  if (reportBtn) {
    reportBtn.addEventListener('click', function() {
      courseRealityModal.show();
    });
  }
});
</script>

<!-- Add this after the report button but before the toast -->
<!-- Modal for asking if the course is real -->
<div class="modal fade" id="courseRealityModal" tabindex="-1" aria-labelledby="courseRealityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courseRealityModalLabel">Course Verification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Is "{{ course.name }}" a real course at your institution?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="voteRealBtn">Yes, it's real</button>
        <button type="button" class="btn btn-danger" id="voteNotRealBtn">No, it's not real</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}